BMU_create_claim_press = {
	debug_log = "BMU_create_claim_press"
	if = {
		limit = {
			exists = $TARGET$
			exists = $TARGET_TITLE$
			exists = $CONTENDER$
			exists = $UNWILLING_CONTENDER$
		}
	}
	$TARGET$ = { save_scope_as = claim_target }
	$TARGET_TITLE$ = { save_scope_as = claimed_title }
	$CONTENDER$ = { save_scope_as = contender }
	$UNWILLING_CONTENDER$ = { save_scope_as = unwilling_contender }

	scope:claim_target = { debug_log = "claim_target [THIS.Char.GetNameNoTooltip]" }
	scope:claimed_title = { debug_log = "claimed_title [THIS.Title.GetNameNoTooltip]" }
	scope:contender = { debug_log = "contender [THIS.Char.GetNameNoTooltip]" }
	scope:unwilling_contender = { debug_log = "unwilling_contender [THIS.Char.GetNameNoTooltip]" }

	scope:claim_target = {
		create_story = {
			type = BMU_pressed_claim
			save_scope_as = story
		}
	}

	add_to_global_variable_list = {
		name = BMU_claim_stories
		target = scope:story
	}

	scope:story = {
		debug_log = story
		debug_log_scopes = no
		set_variable = contention_phase
		set_variable = { name = claimed_title value = scope:claimed_title }
		set_variable = { name = claim_target value = scope:claim_target }

		story_owner = {
			add_to_variable_list = {
				name = claimed_titles
				target = scope:story
			}
			add_to_list = claimants
		}
		var:claimed_title = {
			every_claimant = {
				explicit = all
				add_to_list = claimants
			}
		}
		scope:claim_target = {
			every_targeting_faction = {
				limit = {
					faction_is_type = claimant_faction
					special_title = scope:claimed_title
				}
				every_faction_member = {
					limit = { NOT = { this = prev.special_character }}
					BMU_pressed_claim_supporter = {
						TITLE = scope:claimed_title
						TARGET = scope:claim_target
						CONTENDER = scope:unwilling_contender
					}
				}
			}
		}
		ordered_in_list = {
			list = claimants
			max = 99
			check_range_bounds = no
			order_by = {
				value = 0
				if = {
					limit = { has_title = scope:claimed_title }
					add = 10000
				}
				if = {
					limit = { has_strong_claim_on = scope:claimed_title }
					add = 1000
				}
				else_if = {
					limit = { has_weak_claim_on = scope:claimed_title }
					add = 900
				}
				else = {
					add = 800
				}
				add = highest_held_title_tier
			}
			
			debug_log_scopes = no
			prev = {
				add_to_variable_list = {
					name = claimants
					target = prev
				}
			}
			create_story = {
				type = BMU_stakeholder
				save_scope_as = BMU_stakeholder
			}
			scope:BMU_stakeholder = {
				set_variable = {
					name = pressed_claim
					value = scope:story
				}
				set_variable = claimant
				set_variable = {
					name = stakeholder
					value = story_owner
				}
			}
			scope:story = {
				add_to_variable_list = {
					name = BMU_pressed_claim_stakeholders
					target = scope:BMU_stakeholder
				}
			}
			if = {
				limit = {
					scope:contender = this
					scope:contender = scope:unwilling_contender
				}
				BMU_pressed_claim_supporter = {
					TITLE = scope:claimed_title
					TARGET = scope:claim_target
					CONTENDER = scope:contender
				}
			}
			trigger_event = {
				id = BMU_pressed_claim.0010
				days = 1
			}

			clear_saved_scope = BMU_stakeholder
		}
	}
}

BMU_pressed_claim_supporter = {
	debug_log = "BMU_pressed_claim_supporter"
	debug_log_scopes = no
	save_scope_as = supporter
	$TITLE$ = { save_scope_as = claimed_title }
	$TARGET$ = { save_scope_as = claim_target }
	$CONTENDER$ = { save_scope_as = contender }

	scope:claimed_title = { debug_log_scopes = no }
	scope:claim_target = { debug_log_scopes = no }
	scope:contender = { debug_log_scopes = no }

	random_owned_story = {
		limit = {
			story_type = BMU_stakeholder
			has_variable = pressed_claim
			var:pressed_claim = {
				has_variable = claimed_title
				var:claimed_title = scope:claimed_title
			}
		}
		set_variable = {
			name = top_candidate
			value = scope:contender
		}
		if = {
			limit = { NOT = { scope:contender = scope:supporter }}
			set_variable = {
				name = status
				value = flag:supporter
			}
		}
		else = {
			set_variable = {
				name = status
				value = flag:contender
			}
		}
		var:pressed_claim = {
			BMU_pressed_claim_update_top_contender = yes
		}
	}
}

BMU_pressed_claim_stakeholder = {
	save_scope_as = stakeholder
	$TITLE$ = { save_scope_as = claimed_title }
	$TARGET$ = { save_scope_as = claim_target }

	random_owned_story = {
		limit = {
			story_type = BMU_stakeholder
			has_variable = pressed_claim
			var:pressed_claim = {
				has_variable = claimed_title
				var:claimed_title = scope:claimed_title
			}
		}
		remove_variable = top_candidate
		set_variable = {
			name = status
			value = flag:stakeholder
		}
		var:pressed_claim = {
			BMU_pressed_claim_update_top_contender = yes
		}
	}
}

BMU_pressed_claim_dropout = {
	save_scope_as = dropout
	$TITLE$ = { save_scope_as = claimed_title }
	$TARGET$ = { save_scope_as = claim_target }

	random_owned_story = {
		limit = {
			story_type = BMU_stakeholder
			has_variable = pressed_claim
			var:pressed_claim = {
				has_variable = claimed_title
				var:claimed_title = scope:claimed_title
			}
		}
		remove_variable = top_candidate
		set_variable = {
			name = status
			value = flag:dropout
		}
		var:pressed_claim = {
			BMU_pressed_claim_update_top_contender = yes
		}
	}
}

BMU_pressed_claim_update_top_contender = {
	ordered_in_list = {
		variable = BMU_pressed_claim_stakeholders
		limit = {
			has_variable = status
			var:status = flag:contender
			has_variable = stakeholder
			NOT = { var:stakeholder = scope:claim_target }
		}
		order_by = {
			if = { limit = { save_temporary_scope_as = temp_contender }}
			prev = {
				every_in_list = {
					variable = BMU_claim_stories
					limit = {
						has_variable = status
						OR = {
							var:status = flag:contender
							var:status = flag:supporter
						}
						has_variable = top_candidate
						var:top_candidate = scope:temp_contender
					}
					add = max_military_strength
				}
			}
		}
		prev = {
			set_variable = {
				name = top_contender
				value = prev.story_owner
			}
		}
	}
}

BMU_create_pressed_claim_stakeholder_story = {
	save_scope_as = stakeholder
	$PRESSED_CLAIM$ = { save_scope_as = pressed_claim }
	create_story = {
		type = BMU_stakeholder
		save_scope_as = BMU_stakeholder
	}
	scope:BMU_stakeholder = {
		set_variable = {
			name = pressed_claim
			value = scope:pressed_claim
		}
		set_variable = {
			name = story_owner
			value = story_owner
		}
	}
	scope:pressed_claim = {
		add_to_variable_list = {
			name = BMU_pressed_claim_stakeholders
			target = scope:BMU_stakeholder
		}
	}
	# Ambition Get Title
	scope:pressed_claim = {
		every_in_list = {
			variable = BMU_pressed_claim_stakeholders
			limit = {
				has_variable = status
				var:status = flag:contender
			}
			story_owner = {
				every_held_title = {
					limit = {
						tier >= tier_county
						NOT = { this = prev.primary_title }
					}
					save_scope_as = coveted_title
					scope:stakeholder = {
						save_scope_value_as = {
							name = FF_ambition_get_title
							value = FF_ambition_get_title
						}
						if = {
							limit = { scope:FF_ambition_get_title > 0 }
							create_story = {
								type = BMU_stakeholder_ambition
								save_scope_as = BMU_stakeholder_ambition
							}
							scope:BMU_stakeholder = {
								add_to_variable_list = {
									name = BMU_stakeholder_ambitions
									target = scope:BMU_stakeholder_ambition
								}
							}
							scope:BMU_stakeholder_ambition = {
								set_variable = {
									name = BMU_pressed_claim
									value = scope:pressed_claim
								}
								set_variable = {
									name = BMU_stakeholder
									value = scope:BMU_stakeholder
								}
								set_variable = {
									name = story_owner
									value = story_owner
								}
								set_variable = {
									name = ambition
									value = flag:FF_ambition_get_title
								}
								set_variable = {
									name = coveted_title
									value = scope:coveted_title
								}
								set_variable = {
									name = ambition_score
									value = scope:FF_ambition_get_title
								}
							}
						}
					}
				}
			}
		}
	}
	# Ambition Get Title for child
	every_child = {
		save_scope_as = child
		scope:stakeholder = {
			save_scope_value_as = {
				name = FF_ambition_get_child_title
				value = FF_ambition_get_child_title
			}
			if = {
				limit = { scope:FF_ambition_get_child_title > 0 }
				create_story = {
					type = BMU_stakeholder_ambition
					save_scope_as = BMU_stakeholder_ambition
				}
				scope:BMU_stakeholder = {
					add_to_variable_list = {
						name = BMU_stakeholder_ambitions
						target = scope:BMU_stakeholder_ambition
					}
				}
				scope:BMU_stakeholder_ambition = {
					set_variable = {
						name = BMU_pressed_claim
						value = scope:pressed_claim
					}
					set_variable = {
						name = BMU_stakeholder
						value = scope:BMU_stakeholder
					}
					set_variable = {
						name = story_owner
						value = story_owner
					}
					set_variable = {
						name = ambition
						value = flag:FF_ambition_get_child_title
					}
					set_variable = {
						name = child
						value = scope:child
					}
					set_variable = {
						name = ambition_score
						value = scope:FF_ambition_get_child_title
					}
				}
			}
		}
	}
	# Ambition Get Gold
	scope:stakeholder = {
		save_scope_value_as = {
			name = FF_ambition_get_gold
			value = FF_ambition_get_gold
		}
		if = {
			limit = { scope:FF_ambition_get_gold > 0 }
			create_story = {
				type = BMU_stakeholder_ambition
				save_scope_as = BMU_stakeholder_ambition
			}
			scope:BMU_stakeholder = {
				add_to_variable_list = {
					name = BMU_stakeholder_ambitions
					target = scope:BMU_stakeholder_ambition
				}
			}
			scope:BMU_stakeholder_ambition = {
				set_variable = {
					name = BMU_pressed_claim
					value = scope:pressed_claim
				}
				set_variable = {
					name = BMU_stakeholder
					value = scope:BMU_stakeholder
				}
				set_variable = {
					name = story_owner
					value = story_owner
				}
				set_variable = {
					name = ambition
					value = flag:FF_ambition_get_gold
				}
				set_variable = {
					name = ambition_score
					value = scope:FF_ambition_get_gold
				}
			}
		}
	}
	# Ambition Screw Rival
	scope:stakeholder = {
		save_scope_value_as = {
			name = FF_ambition_screw_rival
			value = FF_ambition_screw_rival
		}
		if = {
			limit = { scope:FF_ambition_screw_rival > 0 }
			every_relation = {
				type = rival
				limit = {
					any_owned_story = {
						story_type = BMU_stakeholder
						var:pressed_claim = scope:pressed_claim
						has_variable = status
						var:status = flag:contender
					}
				}
				save_scope_as = rival
				scope:stakeholder = {
					create_story = {
						type = BMU_stakeholder_ambition
						save_scope_as = BMU_stakeholder_ambition
					}
					scope:BMU_stakeholder = {
						add_to_variable_list = {
							name = BMU_stakeholder_ambitions
							target = scope:BMU_stakeholder_ambition
						}
					}
					scope:BMU_stakeholder_ambition = {
						set_variable = {
							name = BMU_pressed_claim
							value = scope:pressed_claim
						}
						set_variable = {
							name = BMU_stakeholder
							value = scope:BMU_stakeholder
						}
						set_variable = {
							name = story_owner
							value = story_owner
						}
						set_variable = {
							name = ambition
							value = flag:FF_ambition_screw_rival
						}
						set_variable = {
							name = rival
							value = scope:rival
						}
						set_variable = {
							name = ambition_score
							value = scope:FF_ambition_screw_rival
						}
					}
				}
			}
		}
	}
	# Ambition Help Friend
	scope:stakeholder = {
		save_scope_value_as = {
			name = FF_ambition_help_friend
			value = FF_ambition_help_friend
		}
		if = {
			limit = { scope:FF_ambition_help_friend > 0 }
			every_relation = {
				type = friend
				limit = {
					any_owned_story = {
						story_type = BMU_stakeholder
						var:pressed_claim = scope:pressed_claim
						has_variable = status
						var:status = flag:contender
					}
				}
				save_scope_as = friend
				scope:stakeholder = {
					create_story = {
						type = BMU_stakeholder_ambition
						save_scope_as = BMU_stakeholder_ambition
					}
					scope:BMU_stakeholder = {
						add_to_variable_list = {
							name = BMU_stakeholder_ambitions
							target = scope:BMU_stakeholder_ambition
						}
					}
					scope:BMU_stakeholder_ambition = {
						set_variable = {
							name = BMU_pressed_claim
							value = scope:pressed_claim
						}
						set_variable = {
							name = BMU_stakeholder
							value = scope:BMU_stakeholder
						}
						set_variable = {
							name = story_owner
							value = story_owner
						}
						set_variable = {
							name = ambition
							value = flag:FF_ambition_help_friend
						}
						set_variable = {
							name = rival
							value = scope:friend
						}
						set_variable = {
							name = ambition_score
							value = scope:FF_ambition_help_friend
						}
					}
				}
			}
		}
	}
	#Ambition Get Council Position
	scope:stakeholder = {
		if = {
			limit = { FF_ambition_get_council_position > 0 }
			every_in_global_list = {
				variable = FF_council_position_datamodel
				set_local_variable = {
					name = council_position
					value = this
				}
				debug_log = "BMU council position"
				debug_log_scopes = no
				local_var:council_position = { debug_log_scopes = no }
				scope:stakeholder = {
					save_scope_value_as = {
						name = FF_ambition_get_council_position
						value = FF_ambition_get_council_position
					}
				}
				if = {
					limit = { scope:FF_ambition_get_council_position > 0 }
					scope:stakeholder = {
						create_story = {
							type = BMU_stakeholder_ambition
							save_scope_as = BMU_stakeholder_ambition
						}
						scope:BMU_stakeholder = {
							add_to_variable_list = {
								name = BMU_stakeholder_ambitions
								target = scope:BMU_stakeholder_ambition
							}
						}
						scope:BMU_stakeholder_ambition = {
							set_variable = {
								name = BMU_pressed_claim
								value = scope:pressed_claim
							}
							set_variable = {
								name = BMU_stakeholder
								value = scope:BMU_stakeholder
							}
							set_variable = {
								name = story_owner
								value = story_owner
							}
							set_variable = {
								name = ambition
								value = flag:FF_ambition_get_council_position
							}
							set_variable = {
								name = council_position
								value = local_var:council_position
							}
							set_variable = {
								name = ambition_score
								value = scope:FF_ambition_get_council_position
							}
						}
					}
				}
			}
		}
	}
}