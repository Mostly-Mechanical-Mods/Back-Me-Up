BMU_interaction_press_claim = {
	$CLAIMANT$ = { save_scope_as = claimant }
	$CLAIM_TARGET$ = { save_scope_as = claim_target }
	$CLAIMED_TITLE$ = { save_scope_as = claimed_title }

	hidden_effect = {
		scope:claimant = {
			create_story = {
				type = BMU_contender_story
				save_scope_as = contender
			}
		}
	}
	if = {
		limit = { scope:claimed_title = { has_variable = pressed_claim }}
		scope:claimed_title.var:pressed_claim = { save_scope_as = pressed_claim }
		scope:claimant = {
			custom_description = {
				text = BMU_contender_join_pressed_claim
				subject = scope:claimant
				object = scope:claimed_title
			}
		}
		hidden_effect = {
			if = {
				limit = { exists = scope:contender }
				scope:contender = {
					set_variable = {
						name = pressed_claim_story
						value = scope:pressed_claim
					}
					set_variable = {
						name = stakeholder
						value = story_owner
					}
					set_variable = {
						name = story_owner
						value = story_owner
					}
					set_variable = {
						name = status
						value = flag:contender
					}
					set_variable = {
						name = contender
						value = this
					}
					set_variable = {
						name = gambit_budget
						value = {
							add = scope:claimed_title.tier
							add = story_owner.highest_held_title_tier
							scope:claimed_title = {
								if = { limit = { holder = prev.story_owner } add = 5 }
								else_if = { limit = { is_target_in_variable_list = { name = claim_level_4 target = prev.story_owner }} add = 4 }
								else_if = { limit = { is_target_in_variable_list = { name = claim_level_3 target = prev.story_owner }} add = 3 }
								else_if = { limit = { is_target_in_variable_list = { name = claim_level_2 target = prev.story_owner }} add = 2 }
								else_if = { limit = { is_target_in_variable_list = { name = claim_level_1 target = prev.story_owner }} add = 1 }
							}
							multiply = 10
						}
					}
					set_variable = {
						name = willingness_budget
						value = story_owner.BMU_ambition_get_title
					}
					story_owner = {
						add_to_variable_list = {
							name = pressed_claim_gui
							target = scope:pressed_claim
						}
						set_variable = {
							name = pressed_claim_interaction
							value = scope:pressed_claim
						}
					}
				}
				scope:pressed_claim = {
					add_to_variable_list = {
						name = contenders
						target = scope:contender
					}
				}
			}
		}
	}
	else = {
		hidden_effect = {
			scope:claim_target = {
				create_story = {
					type = BMU_pressed_claim_story
					save_scope_as = pressed_claim
				}
				create_story = {
					type = BMU_contender_story
					save_scope_as = claim_target_contender
				}
			}
			if = {
				limit = {
					exists = scope:pressed_claim
					exists = scope:contender
					exists = scope:claim_target_contender
				}
				scope:contender = {
					set_variable = {
						name = pressed_claim_story
						value = scope:pressed_claim
					}
					set_variable = {
						name = stakeholder
						value = story_owner
					}
					set_variable = {
						name = story_owner
						value = story_owner
					}
					set_variable = {
						name = status
						value = flag:contender
					}
					set_variable = {
						name = contender
						value = this
					}
					set_variable = {
						name = gambit_budget
						value = {
							add = scope:claimed_title.tier
							add = story_owner.highest_held_title_tier
							scope:claimed_title = {
								if = { limit = { holder = prev.story_owner } add = 5 }
								else_if = { limit = { is_target_in_variable_list = { name = claim_level_4 target = prev.story_owner }} add = 4 }
								else_if = { limit = { is_target_in_variable_list = { name = claim_level_3 target = prev.story_owner }} add = 3 }
								else_if = { limit = { is_target_in_variable_list = { name = claim_level_2 target = prev.story_owner }} add = 2 }
								else_if = { limit = { is_target_in_variable_list = { name = claim_level_1 target = prev.story_owner }} add = 1 }
							}
							multiply = 10
						}
					}
					set_variable = {
						name = willingness_budget
						value = story_owner.BMU_ambition_get_title
					}
					story_owner = {
						add_to_variable_list = {
							name = pressed_claim_gui
							target = scope:pressed_claim
						}
						set_variable = {
							name = pressed_claim_interaction
							value = scope:pressed_claim
						}
					}
				}
				scope:claim_target_contender = {
					set_variable = {
						name = pressed_claim_story
						value = scope:pressed_claim
					}
					set_variable = {
						name = stakeholder
						value = story_owner
					}
					set_variable = {
						name = story_owner
						value = story_owner
					}
					set_variable = {
						name = status
						value = flag:contender
					}
					set_variable = {
						name = contender
						value = this
					}
					set_variable = {
						name = gambit_budget
						value = {
							add = scope:claimed_title.tier
							add = story_owner.highest_held_title_tier
							scope:claimed_title = {
								if = { limit = { holder = prev.story_owner } add = 5 }
								else_if = { limit = { is_target_in_variable_list = { name = claim_level_4 target = prev.story_owner }} add = 4 }
								else_if = { limit = { is_target_in_variable_list = { name = claim_level_3 target = prev.story_owner }} add = 3 }
								else_if = { limit = { is_target_in_variable_list = { name = claim_level_2 target = prev.story_owner }} add = 2 }
								else_if = { limit = { is_target_in_variable_list = { name = claim_level_1 target = prev.story_owner }} add = 1 }
							}
							multiply = 10
						}
					}
					set_variable = {
						name = willingness_budget
						value = story_owner.BMU_ambition_get_title
					}
					story_owner = {
						add_to_variable_list = {
							name = pressed_claim_gui
							target = scope:pressed_claim
						}
						set_variable = {
							name = pressed_claim_interaction
							value = scope:pressed_claim
						}
					}
				}
				scope:pressed_claim = {
					set_variable = {
						name = claim_target
						value = scope:claim_target
					}
					set_variable = {
						name = claimed_title
						value = scope:claimed_title
					}
					add_to_variable_list = {
						name = contenders
						target = scope:contender
					}
					add_to_variable_list = {
						name = contenders
						target = scope:claim_target_contender
					}
				}
				scope:claimed_title = {
					every_claimant = {
						scope:pressed_claim = {
							add_to_variable_list = {
								name = claimants
								target = prev
							}
						}
					}
					set_variable = {
						name = pressed_claim
						value = scope:pressed_claim
					}
				}
				scope:claim_target = {
					every_heir = {
						scope:pressed_claim = {
							add_to_variable_list = {
								name = claimants
								target = prev
							}
						}
					}
				}
			}
		}

		scope:claimant = {
			custom_description = {
				text = BMU_contender_create_pressed_claim
				subject = scope:claimant
				object = scope:claimed_title
			}
		}
		scope:claim_target = {
			custom_description = {
				text = BMU_claim_target_defend_pressed_claim
				subject = scope:claim_target
				object = scope:claimed_title
			}
		}
		scope:claimant = { add_to_list = claimants }
		scope:claim_target = { add_to_list = claimants }
		scope:claim_target = {
			every_targeting_faction = {
				limit = {
					faction_is_type = claimant_faction
					special_title = scope:claimed_title
					NOT = { has_variable = pressed_claim }
				}
				set_variable = {
					name = pressed_claim
					value = scope:pressed_claim
				}
				special_character = { set_variable = BMU_request_support_interaction_script_override }
				if = {
					limit = { NOT = { special_character = scope:claimant }}
					special_character = {
						custom_description = {
							text = BMU_contender_join_pressed_claim
							subject = this
							object = scope:claimed_title
							add_to_list = claimants
							create_story = {
								type = BMU_contender_story
								save_scope_as = faction_claimant
							}
							if = {
								limit = { exists = scope:faction_claimant }
								scope:faction_claimant = {
									set_variable = {
										name = pressed_claim_story
										value = scope:pressed_claim
									}
									set_variable = {
										name = stakeholder
										value = story_owner
									}
									set_variable = {
										name = story_owner
										value = story_owner
									}
									set_variable = {
										name = status
										value = flag:contender
									}
									set_variable = {
										name = contender
										value = this
									}
									set_variable = {
										name = gambit_budget
										value = {
											add = scope:claimed_title.tier
											add = story_owner.highest_held_title_tier
											scope:claimed_title = {
												if = { limit = { holder = prev.story_owner } add = 5 }
												else_if = { limit = { is_target_in_variable_list = { name = claim_level_4 target = prev.story_owner }} add = 4 }
												else_if = { limit = { is_target_in_variable_list = { name = claim_level_3 target = prev.story_owner }} add = 3 }
												else_if = { limit = { is_target_in_variable_list = { name = claim_level_2 target = prev.story_owner }} add = 2 }
												else_if = { limit = { is_target_in_variable_list = { name = claim_level_1 target = prev.story_owner }} add = 1 }
											}
											multiply = 10
										}
									}
									set_variable = {
										name = willingness_budget
										value = story_owner.BMU_ambition_get_title
									}
									story_owner = {
										add_to_variable_list = {
											name = pressed_claim_gui
											target = scope:pressed_claim
										}
										set_variable = {
											name = pressed_claim_interaction
											value = scope:pressed_claim
										}
									}
									scope:pressed_claim = {
										add_to_variable_list = {
											name = contenders
											target = prev
										}
									}
								}
							}
						}
					}
				}
				add_to_variable_list = {
					name = pressed_claim_supporters
					target = special_character
				}
				every_faction_member = {
					limit = { NOT = { this = prev.special_character }}
					custom_description = {
						text = BMU_start_supporting_contender
						subject = this
						object = prev.special_character
						run_interaction = {
							interaction = BMU_request_support_interaction
							actor = prev.special_character
							recipient = this
							redirect = yes
							execute_threshold = decline
						}
					}
					prev = {
						add_to_variable_list = {
							name = pressed_claim_supporters
							target = prev
						}
					}
				}
				special_character = { remove_variable = BMU_request_support_interaction_script_override }
			}
		}
		scope:claimed_title = {
			every_claimant = {
				limit = { NOT = { is_in_list = claimants }}
				custom_description = {
					text = BMU_claimant_might_join_pressed_claim
					subject = this
					object = scope:claimed_title
				}
			}
		}
	}
	
	
	if = {
		limit = { exists = scope:pressed_claim }
		scope:pressed_claim = {
			every_in_list = {
				variable = contenders
				limit = { NOT = { story_owner = { is_in_list = claimants }}}
				story_owner = {
					send_interface_message = {
						type = BMU_contender_join_pressed_claim # default: send_interface_message
						# desc = event_message_effect
						left_icon = scope:claimant
						right_icon = scope:claimed_title
						custom_description = {
							text = BMU_contender_join_pressed_claim
							subject = scope:claimant
							object = scope:claimed_title
						}
					}
				}
			}
		}
	}

	hidden_effect = {
		if = {
			limit = { exists = scope:pressed_claim }
			BMU_pressed_claim_update_top_contender = { PRESSED_CLAIM = scope:pressed_claim }
			# scope:claim_target = {
			# 	every_vassal = {
			# 		limit = { BMU_is_claim_target_vassal_that_follows_pressed_claim = { PRESSED_CLAIM = scope:pressed_claim }}
			# 		scope:claimant = { BMU_set_relation_stakeholder = { FLAG = future_vassal TARGET = prev PRESSED_CLAIM = scope:pressed_claim }}
			# 	}
			# 	every_relation = {
			# 		type = rival
			# 		scope:claimant = { BMU_set_relation_stakeholder = { FLAG = contender_rival TARGET = prev PRESSED_CLAIM = scope:pressed_claim }}
			# 	}
			# }
			# scope:claimant = {
			# 	every_relation = {
			# 		type = rival
			# 		save_scope_as = rival
			# 		scope:pressed_claim = {
			# 			every_in_list = {
			# 				variable = contenders

			# 			}
			# 		}
			# 	}
			# }
		}
	}
}

BMU_update_confidence = {
	set_variable = {
		name = confidence_score
		value = BMU_confidence
	}
	if = {
		limit = { var:confidence_score >= 1.2 }
		set_variable = { name = confidence_flag value = flag:confidence_cocky }
	}
	else_if = {
		limit = { var:confidence_score >= 1 }
		set_variable = { name = confidence_flag value = flag:confidence_confident }
	}
	else_if = {
		limit = { var:confidence_score >= 1 }
		set_variable = { name = confidence_flag value = flag:confidence_concerned }
	}
	else = { set_variable = { name = confidence_flag value = flag:confidence_fearful }}
}

BMU_set_relation_stakeholder = {
	$TARGET$ = { save_scope_as = stakeholder }
	if = {
		limit = { NOT = { has_relation_stakeholder_proxy = scope:stakeholder }}
		set_relation_stakeholder_proxy = scope:stakeholder
	}
	add_relation_flag = {
		flag = $FLAG$
		target = scope:stakeholder
		relation = stakeholder_proxy
	}
	clear_saved_scope = stakeholder
}

BMU_calc_best_contenders = {
	if = {
		limit = { debug_only = yes }
		debug_log = "BMU_calc_best_contenders"
		debug_log_scopes = no
		story_owner = { debug_log_scopes = no }
	}
	save_scope_as = temp_story
	if  = {
		limit = { NOT = { exists = scope:pressed_claim }}
		$PRESSED_CLAIM$ = { save_scope_as = pressed_claim }
	}
	remove_variable = best_contender
	remove_variable = worthy_contender
	scope:pressed_claim = {
		ordered_in_list = {
			variable = contenders
			order_by = {
				story_owner = {
					save_temporary_scope_as = score_contender
					scope:temp_story.story_owner = { add = BMU_contender_score }
				}
			}
			max = 2
			check_range_bounds = no
			if = { limit = { story_owner = { save_temporary_scope_as = score_contender }}}
			scope:temp_story = {
				if = {
					limit = { NOT = { has_variable = best_contender }}
					if = {
						limit = { debug_only = yes }
						debug_log = "best_contender"
						prev = {
							debug_log_scopes = no
							story_owner = { debug_log_scopes = no }
						}
					}
					set_variable = {
						name = best_contender
						value = prev.story_owner
					}
					set_variable = {
						name = best_contender_score
						value = { scope:temp_story.story_owner = { add = BMU_contender_score }}
					}
				}
				else = {
					if = {
						limit = { debug_only = yes }
						debug_log = "worthy_contender"
						prev = {
							debug_log_scopes = no
							story_owner = { debug_log_scopes = no }
						}
					}
					set_variable = {
						name = worthy_contender
						value = prev.story_owner
					}
					set_variable = {
						name = worthy_contender_score
						value = { scope:temp_story.story_owner = { add = BMU_contender_score }}
					}
				}
			}
		}
	}
	clear_saved_scope = temp_pressed_claim
	clear_saved_scope = temp_story
}

BMU_spend_gambits_effect_actor = {
	scope:actor.var:pressed_claim_interaction = { save_scope_as = pressed_claim }
	scope:actor = {
		random_contender_story = {
			limit = { var:pressed_claim_story = scope:actor.var:pressed_claim_interaction }
			change_variable = {
				name = gambit_spent
				add = BMU_supporter_gambit_cost
			}
		}
	}
}

BMU_spend_gambits_effect_recipient = {
	scope:actor.var:pressed_claim_interaction = { save_scope_as = pressed_claim }
	scope:recipient = {
		random_contender_story = {
			limit = { var:pressed_claim_story = scope:actor.var:pressed_claim_interaction }
			change_variable = {
				name = gambit_spent
				add = BMU_supporter_gambit_cost_recipient
			}
		}
	}
}

BMU_refund_gambits_effect = {
	if = {
		limit = { exists = scope:pressed_claim }
		scope:actor = {
			random_contender_story = {
				limit = { var:pressed_claim_story = scope:pressed_claim }
				change_variable = {
					name = gambit_spent
					subtract = BMU_supporter_gambit_cost
				}
			}
		}
	}
}

BMU_request_support = {
	$CONTENDER$ = {
		random_contender_story = {
			limit = { var:pressed_claim_story = $PRESSED_CLAIM$ }
			save_scope_as = contender
		}
		custom_description = {
			text = BMU_spend_gambits
			subject = $CONTENDER$
			object = $SUPPORTER$
			value = BMU_supporter_gambit_cost
		}
	}
	if = {
		limit = {
			$SUPPORTER$ = {
				any_supporter_story = {
					var:pressed_claim_story = $PRESSED_CLAIM$
					count = 0
				}
			}
		}
		$SUPPORTER$ = {
			create_story = {
				type = BMU_supporter_story
				save_scope_as = supporter
			}
			if = {
				limit = {
					exists = scope:supporter
					exists = scope:supporter.story_owner
				}
				scope:supporter = {
					set_variable = {
						name = pressed_claim_story
						value = $PRESSED_CLAIM$
					}
					set_variable = {
						name = stakeholder
						value = story_owner
					}
					set_variable = {
						name = story_owner
						value = story_owner
					}
					set_variable = {
						name = status
						value = flag:supporter
					}
					story_owner = {
						set_variable = {
							name = pressed_claim_interaction
							value = $PRESSED_CLAIM$
						}
						add_to_variable_list = {
							name = pressed_claim_gui
							target = $PRESSED_CLAIM$
						}
					}
					# BMU_create_bargain = {
					# 	PRESSED_CLAIM = $PRESSED_CLAIM$
					# 	CONTENDER = $CONTENDER$
					# 	SUPPORTER = $SUPPORTER$
					# }
					# BMU_calc_best_contenders = { PRESSED_CLAIM = $PRESSED_CLAIM$ }
				}
				$PRESSED_CLAIM$ = {
					add_to_variable_list = {
						name = supporters
						target = scope:supporter
					}
				}
				random_stakeholder_story = {
					limit = { var:pressed_claim_story = $PRESSED_CLAIM$ }
					if = {
						limit = { debug_only = yes }
						set_variable = { name = end_story value = flag:call_in_supporter_on_accept }
					}
					end_story = yes
				}
			}
		}
	}
	else = {
		$SUPPORTER$ = {
			random_supporter_story = {
				limit = { var:pressed_claim_story = $PRESSED_CLAIM$ }
				save_scope_as = supporter
			}
		}
	}
	if = {
		limit = {
			exists = scope:supporter
			scope:supporter = { has_variable = contender }
		}
		$SUPPORTER$ = {
			custom_description = {
				text = BMU_stop_supporting_contender
				subject = $SUPPORTER$
				object = scope:supporter.var:contender.story_owner
				scope:supporter.var:contender.story_owner = {
					send_interface_toast = {
						title = BMU_SUPPORTER_LOST
						left_icon = $SUPPORTER$
						right_icon = $CONTENDER$
					
						random_bargain = {
							limit = { var:pressed_claim = $PRESSED_CLAIM$ }
							if = {
								limit = { debug_only = yes }
								set_variable = { name = end_story value = flag:call_in_supporter_on_accept }
							}
							end_story = yes
						}
					}
				}
			}
		}
	}
	$SUPPORTER$ = {
		custom_tooltip = {
			text = BMU_recipient_supports_actor_claim
			if = {
				limit = { exists = scope:supporter }
				scope:supporter = {
					set_variable = {
						name = contender
						value = scope:contender
					}
					# BMU_create_bargain = {
					# 	PRESSED_CLAIM = $PRESSED_CLAIM$
					# 	CONTENDER = $CONTENDER$
					# 	SUPPORTER = $SUPPORTER$
					# }
				}
				scope:supporter = { BMU_calc_best_contenders = { PRESSED_CLAIM = $PRESSED_CLAIM$ }}
			}
		} 
	}

	$PRESSED_CLAIM$ = {
		add_to_variable_list = {
			name = supporters
			target = scope:supporter
		}
	}

	$PRESSED_CLAIM$ = {
		every_in_list = {
			variable = contenders
			limit = { NOT = { story_owner = $CONTENDER$ }}
			story_owner = {
				send_interface_message = {
					type = BMU_contender_gains_support # default: send_interface_message
					# desc = event_message_effect
					left_icon = $CONTENDER$
					right_icon = scope:claimed_title
					custom_description = {
						text = BMU_start_supporting_contender
						subject = $SUPPORTER$
						object = $CONTENDER$
					}
				}
			}
		}
	}
}

BMU_bargain_owned_title_post_effect = {
	$CONTENDER$ = {
		custom_description_no_bullet = {
			text = BMU_if_pressed_claim_won
			subject = $CONTENDER$
			object = $PRESSED_CLAIM$.var:claimed_title
		}
	}
	$SUPPORTER$ = {
		custom_description_no_bullet = {
			text = BMU_if_pressed_claim_won
			subject = $SUPPORTER$
			object = $PRESSED_CLAIM$.var:claimed_title
		}
	}
	$TARGET$ = { add_to_list = target_titles }
	BMU_grant_titles = yes
	create_title_and_vassal_change = {
		type = granted
		save_scope_as = bargain
	}
	every_in_list = {
		list = target_titles
		change_title_holder_include_vassals = {
			holder = $SUPPORTER$
			change = scope:bargain
		}
	}
	resolve_title_and_vassal_change = scope:bargain
}

BMU_bargain_council_position_post_effect = {
	$CONTENDER$ = {
		custom_description_no_bullet = {
			text = BMU_if_pressed_claim_won
			subject = $CONTENDER$
			object = $PRESSED_CLAIM$.var:claimed_title
		}
		if = {
			limit = { scope:councillor_chancellor = yes }
			assign_councillor_type = {
				type = councillor_chancellor
				target = $SUPPORTER$
			}
		}
		else_if = {
			limit = { scope:councillor_steward = yes }
			assign_councillor_type = {
				type = councillor_steward
				target = $SUPPORTER$
			}
		}
		else_if = {
			limit = { scope:councillor_marshal = yes }
			assign_councillor_type = {
				type = councillor_marshal
				target = $SUPPORTER$
			}
		}
		else_if = {
			limit = { scope:councillor_spymaster = yes }
			assign_councillor_type = {
				type = councillor_spymaster
				target = $SUPPORTER$
			}
		}
	}
}