BMU_bargain_with_council_position_interaction = {
	category = interaction_category_diplomacy
	use_diplomatic_range = no
	common_interaction = yes
	ignores_pending_interaction_block = yes
	interface_priority = -1
	icon = bargain_council_position

	desc = BMU_bargain_with_council_position_interaction_desc

	auto_accept = no
	ai_min_reply_days = 4
	ai_max_reply_days = 9

	popup_on_receive = yes
	pause_on_receive = yes
	can_send_despite_rejection = no
	ignores_pending_interaction_block = no

	redirect = {
	}

	is_shown = {
		NOT = { scope:actor = scope:recipient }
		BMU_have_common_pressed_claim = { STAKEHOLDER_1 = scope:actor STAKEHOLDER_2 = scope:recipient }
	}

	
	is_valid_showing_failures_only = {
		trigger_if = {
			limit = {
				NOT = { scope:actor = { has_variable = current_pressed_claim }}
			}
			custom_description = {
				text = BMU_have_common_pressed_claim
				subject = scope:actor
				object = scope:recipient
				BMU_have_common_pressed_claim = { STAKEHOLDER_1 = scope:actor STAKEHOLDER_2 = scope:recipient }
			}
			custom_description = {
				text = BMU_have_unique_common_pressed_claim
				subject = scope:actor
				object = scope:recipient
				exists = scope:common_pressed_claim
			}
			trigger_if = {
				limit = { exists = scope:common_pressed_claim }
				scope:recipient = {
					BMU_can_be_councillor_of = { PRESSED_CLAIM = scope:common_pressed_claim COURT_OWNER = scope:actor }
					FF_has_ambition_get_council_position = yes
				}
			}
		}
	}



	can_send = {
	}

	options_heading = BMU_bargain_council_position_interaction_option
	# flag:FF_ambition_get_council_position
	send_option = {
		is_shown = { always = no }
		is_valid = { always = no }
		flag = FF_ambition_get_council_position
	}
	# flag:councillor_chancellor
	send_option = {
		is_shown = { }								# Is option shown
		is_valid = {
			scope:recipient = {
				BMU_can_be_chancellor_of = { COURT_OWNER = scope:actor }
				FF_ambition_get_council_position_chancellor > 0
			}
		}
		flag = councillor_chancellor
		localization = BMU_bargain_council_position_interaction_option_chancellor
		can_invalidate_interaction = no
	}
	# flag:councillor_steward
	send_option = {
		is_shown = { }								# Is option shown
		is_valid = {
			scope:recipient = {
				BMU_can_be_steward_of = { COURT_OWNER = scope:actor }
				FF_ambition_get_council_position_steward > 0
			}
		}
		flag = councillor_steward
		localization = BMU_bargain_council_position_interaction_option_steward
		can_invalidate_interaction = no
	}
	# flag:councillor_marshal
	send_option = {
		is_shown = { }								# Is option shown
		is_valid = {
			scope:recipient = {
				BMU_can_be_marshal_of = { COURT_OWNER = scope:actor }
				FF_ambition_get_council_position_marshal > 0
			}
		}
		flag = councillor_marshal
		localization = BMU_bargain_council_position_interaction_option_marshal
		can_invalidate_interaction = no
	}
	# flag:councillor_spymaster
	send_option = {
		is_shown = { }								# Is option shown
		is_valid = {
			scope:recipient = {
				BMU_can_be_spymaster_of = { COURT_OWNER = scope:actor }
				FF_ambition_get_council_position_spymaster > 0
			}
		}
		flag = councillor_spymaster
		localization = BMU_bargain_council_position_interaction_option_spymaster
		can_invalidate_interaction = no
	}

	on_send = {
		scope:actor = {
			set_variable = {
				name = pending_bargain
				value = scope:recipient
			}
		}
	}
	
	on_accept = {
		# BMU_accept_bargain_with = yes
		hidden_effect = {
			if = {
				limit = {
					BMU_have_common_pressed_claim = { STAKEHOLDER_1 = scope:actor STAKEHOLDER_2 = scope:recipient }
					exists = scope:common_pressed_claim
					scope:stakeholder_1_story = { save_temporary_scope_as = contender }
					scope:stakeholder_2_story = { save_temporary_scope_as = supporter }
				}
			}
		}
		BMU_create_bargain_get_council_position = yes
				
		scope:actor = {
			custom_description_no_bullet = {
				text = BMU_if_pressed_claim_won
				subject = scope:actor
				object = scope:common_pressed_claim.var:claimed_title
			}
			show_as_tooltip = {
				if = {
					limit = { scope:councillor_chancellor = yes }
					assign_councillor_type = {
						type = councillor_chancellor
						target = scope:recipient
					}
				}
				else_if = {
					limit = { scope:councillor_steward = yes }
					assign_councillor_type = {
						type = councillor_steward
						target = scope:recipient
					}
				}
				else_if = {
					limit = { scope:councillor_marshal = yes }
					assign_councillor_type = {
						type = councillor_marshal
						target = scope:recipient
					}
				}
				else_if = {
					limit = { scope:councillor_spymaster = yes }
					assign_councillor_type = {
						type = councillor_spymaster
						target = scope:recipient
					}
				}
			}
		}
	}

	
	ai_accept = {
		base = 0
		BMU_bargain_setup = yes
		modifier = {
			exists = scope:common_pressed_claim
			add = FF_bargain_acceptance_support_for_bargainer
			desc = "FF_bargain_acceptance_support_for_bargainer_modifier"
		}
		modifier = {
			exists = scope:common_pressed_claim
			add = FF_bargain_acceptance_military_leverage
			desc = "FF_bargain_acceptance_military_leverage_modifier"
		}
		modifier = {
			exists = scope:FF_ambition_get_council_position
			exists = scope:councillor_chancellor
			scope:councillor_chancellor = yes
			add = FF_ambition_get_council_position_chancellor
			desc = "FF_ambition_get_council_position_chancellor_modifier"
		}
		modifier = {
			exists = scope:FF_ambition_get_council_position
			exists = scope:councillor_steward
			scope:councillor_steward = yes
			add = FF_ambition_get_council_position_steward
			desc = "FF_ambition_get_council_position_steward_modifier"
		}
		modifier = {
			exists = scope:FF_ambition_get_council_position
			exists = scope:councillor_marshal
			scope:councillor_marshal = yes
			add = FF_ambition_get_council_position_marshal
			desc = "FF_ambition_get_council_position_marshal_modifier"
		}
		modifier = {
			exists = scope:FF_ambition_get_council_position
			exists = scope:councillor_spymaster
			scope:councillor_spymaster = yes
			add = FF_ambition_get_council_position_spymaster
			desc = "FF_ambition_get_council_position_spymaster_modifier"
		}
	}

	ai_will_do = {
		base = 0
		BMU_bargain_setup = yes
		modifier = {
			scope:councillor_chancellor = yes
			any_councillor = {
				trigger_if = { limit = { scope:councillor_chancellor = yes } has_council_position = councillor_chancellor }
				trigger_else_if = { limit = { scope:councillor_steward = yes } has_council_position = councillor_steward }
				trigger_else_if = { limit = { scope:councillor_marshal = yes } has_council_position = councillor_marshal }
				trigger_else_if = { limit = { scope:councillor_spymaster = yes } has_council_position = councillor_spymaster }
				trigger_else = { always = no }
				any_owned_story = {
					story_type = BMU_stakeholder_story
					var:pressed_claim_story = scope:common_pressed_claim
					var:status = flag:supporter
					var:contender = scope:actor
					prev = { save_temporary_scope_as = current_councillor }
				}
			}
			add = {
				add = scope:current_councillor.max_military_strength
				divide = scope:recipient.max_military_strength
				multiply = 100
				subtract = 100
			}
			desc = "BMU_bargain_for_council_position_weaker_than_current_councillor_supporter"
		}
	}
}
