namespace = BMU_pressed_claim

#First Contender informs target + claimants that they are pressing their claim
BMU_pressed_claim.0010 = {
	type = letter_event
	opening = BMU_CLAIMANT_INVITE
	desc = BMU_CLAIMANT_INVITE_DESC
	sender = scope:contender

	trigger = {
		NOT = { this = scope:contender }
		exists = scope:story
	}

	immediate = {
		debug_log = "BMU_pressed_claim.0010"
		debug_log_scopes = no

		random_BMU_stakeholder = {
			limit = {
				exists = var:pressed_claim
				var:pressed_claim = scope:story
			}
			save_scope_as = BMU_stakeholder
		}
		
		scope:claim_target = {
			save_scope_as = candidate
			debug_log = "target"
			debug_log_scopes = no
		}
		save_scope_value_as = {
			name = target_score
			value = candidate_score
		}

		scope:story.var:claimed_title = {
			save_scope_as = coveted_title	
		}
		
		if = {
			limit = { scope:target_score < 0 }
			save_scope_value_as = {
				name = wants_target_title_score
				value = FF_ambition_get_title
			}

			if = {
				limit = { scope:wants_target_title_score <= 0 }
				scope:story = {
					ordered_in_list = {
						variable = BMU_pressed_claim_stakeholders
						limit = {
							NOR = {
								story_owner = scope:claim_target
								story_owner = root
							}
						}
						order_by = {
							if = { limit = { story_owner = { save_temporary_scope_as = candidate }}}
							root = { add = candidate_score }
						}
						story_owner = {
							save_scope_as = best_other_candidate
							save_scope_as = candidate
							debug_log = "best_other_candidate"
							debug_log_scopes = no
						}
						root = {
							save_scope_value_as = {
								name = best_other_candidate_score
								value = candidate_score
							}
						}
					}
				}
			}
		}

	}

	option = {
		name = {
			trigger = {
				NOR = {
					root = scope:claim_target
					root = scope:unwilling_contender
				}
			}
			text = "BMU_CLAIMANT_INVITE_CONTENDER"
		}
		name = {
			trigger = { root = scope:claim_target }
			text = "BMU_CLAIMANT_INVITE_CONTENDER_TARGET"
		}
		name = {
			trigger = { root = scope:unwilling_contender }
			text = "BMU_CLAIMANT_INVITE_CONTENDER_UNWILLING_CONTENDER"
		}
		trigger = {
			trigger_if = {
				limit = {
					NOT = { root = scope:claim_target }
					OR = {
						is_adult = no
						is_weak_claimant_due_to_gender_trigger = { FAITH = root.faith CHARACTER = root }
					}
				}
				scope:story.story_owner = {
					OR = {
						is_adult = no
						is_weak_claimant_due_to_gender_trigger = { FAITH = root.faith CHARACTER = scope:claim_target }
					}
				}
			}
		}
		custom_tooltip = BMU_CLAIMANT_INVITE_CONTENDER_TOOLTIP

		BMU_pressed_claim_supporter = {
			TITLE = scope:story.var:claimed_title
			TARGET = scope:claim_target
			CONTENDER = root
		}

		if = {
			limit = { root = scope:unwilling_contender }
			scope:contender = {
				BMU_pressed_claim_supporter = {
					TITLE = scope:story.var:claimed_title
					TARGET = scope:claim_target
					CONTENDER = root
				}
			}
		}
		
		ai_chance = {
			base = 0
			modifier = {
				scope:target_score < 0
				scope:wants_target_title_score > 0
				add = 100
			}
		}
	}

	option = {
		name = "BMU_CLAIMANT_INVITE_STAKEHOLDER"
		trigger = {
			NOT = { this = scope:claim_target }
			is_landed = yes
		}
		custom_tooltip = BMU_CLAIMANT_INVITE_STAKEHOLDER_TOOLTIP
		if = {
			limit = {
				exists = scope:best_other_candidate_score
				scope:best_other_candidate_score > scope:target_score
			}
			BMU_pressed_claim_supporter = {
				TITLE = scope:story.var:claimed_title
				TARGET = scope:claim_target
				CONTENDER = scope:best_other_candidate
			}
		}
		else = {
			BMU_pressed_claim_stakeholder = {
				TITLE = scope:story.var:claimed_title
				TARGET = scope:claim_target
			}
			
		}

		ai_chance = {
			base = 0
			modifier = {
				scope:target_score < 0
				scope:wants_target_title_score <= 0
				trigger_if = {
					limit = { exists = scope:best_other_candidate_score }
					scope:best_other_candidate_score > 0
				}
				add = 100
			}
		}
	}

	option = {
		name = "BMU_CLAIMANT_INVITE_DROPOUT"
		trigger = { NOT = { this = scope:claim_target }}
		BMU_pressed_claim_dropout = {
			TITLE = scope:story.var:claimed_title
			TARGET = scope:claim_target
		}
		ai_chance = {
			base = 0
			modifier = {
				scope:target_score >= 0
				add = 100
			}
			modifier = {
				scope:target_score < 0
				scope:wants_target_title_score <= 0
				trigger_if = {
					limit = { exists = scope:best_other_candidate_score }
					scope:best_other_candidate_score < 0
				}
				add = 100
			}
		}
	}
}

#Claim Target calls in allies
BMU_pressed_claim.0011 = {
	type = letter_event
	sender = scope:claim_target
	opening = BMU_TARGET_INVITE_ALLIES
	desc = BMU_TARGET_INVITE_ALLIES_DESC

	immediate = {
		debug_log = "BMU_pressed_claim.0011"
		debug_log_scopes = no

		create_story = {
			type = BMU_stakeholder
			save_scope_as = BMU_stakeholder
		}
		scope:BMU_stakeholder = {
			set_variable = {
				name = pressed_claim
				value = scope:story
			}
		}
		scope:story = {
			add_to_variable_list = {
				name = BMU_pressed_claim_stakeholders
				target = scope:BMU_stakeholder
			}
		}
	}

	option = {
		name = "BMU_TARGET_INVITE_ALLIES_SUPPORTER"
		BMU_pressed_claim_supporter = {
			TITLE = scope:story.var:claimed_title
			TARGET = scope:claim_target
			CONTENDER = scope:claim_target
		}
		ai_chance = {
			base = 100
		}
	}

	option = {
		name = "BMU_TARGET_INVITE_ALLIES_STAKEHOLDER"
		scope:BMU_stakeholder = {
			set_variable = {
				name = status
				value = flag:stakeholder
			}
		}
		ai_chance = {
			base = 0
		}
	}

	option = {
		name = "BMU_TARGET_INVITE_ALLIES_DROPOUT"
		scope:BMU_stakeholder = {
			set_variable = {
				name = status
				value = flag:dropout
			}
		}
		break_alliance = scope:claim_target
		scope:claim_target = {
			add_opinion = {
				modifier = rejected_call_to_defensive_war
				target = root
			}
		}
		add_prestige_experience = massive_prestige_loss
		ai_chance = {
			base = 0
		}
	}
}

#Contenders call in allies
BMU_pressed_claim.0012 = {
	type = letter_event
	sender = scope:contender
	opening = BMU_CONTENDER_INVITE_ALLIES
	desc = BMU_CONTENDER_INVITE_ALLIES_DESC

	immediate = {
		debug_log = "BMU_pressed_claim.0012"
		debug_log_scopes = no

		create_story = {
			type = BMU_stakeholder
			save_scope_as = BMU_stakeholder
		}
		scope:BMU_stakeholder = {
			set_variable = {
				name = pressed_claim
				value = scope:story
			}
		}
		scope:story = {
			add_to_variable_list = {
				name = BMU_pressed_claim_stakeholders
				target = scope:BMU_stakeholder
			}
		}
	}

	option = {
		name = "BMU_CONTENDER_INVITE_ALLIES_SUPPORTER"
		ai_chance = {
			base = 0
			modifier = {
				any_ally = {
					any_owned_story = {
						story_type = BMU_stakeholder
						var:pressed_claim = scope:story
						has_variable = status
						var:status = flag:contender
					}
					NOT = { this = scope:contender }
					count = 0
				}
				add = 100
			}
		}
		BMU_pressed_claim_supporter = {
			TITLE = scope:story.var:claimed_title
			TARGET = scope:claim_target
			CONTENDER = scope:contender
		}
	}

	option = {
		name = "BMU_CONTENDER_INVITE_ALLIES_STAKEHOLDER"
		ai_chance = {
			base = 0
			modifier = {
				any_ally = {
					any_owned_story = {
						story_type = BMU_stakeholder
						var:pressed_claim = scope:story
						has_variable = status
						var:status = flag:contender
					}
					NOT = { this = scope:contender }
				}
				add = 100
			}
		}
		scope:BMU_stakeholder = {
			set_variable = {
				name = status
				value = flag:stakeholder
			}
		}
	}

	option = {
		name = "BMU_TARGET_INVITE_ALLIES_DROPOUT"
		scope:BMU_stakeholder = {
			set_variable = {
				name = status
				value = flag:dropout
			}
		}
		scope:claim_target = {
			add_opinion = {
				modifier = rejected_call_to_offensive_war
				target = root
			}
		}
		add_prestige_experience = massive_prestige_loss
	}
}

#Claim Target calls in vassals
BMU_pressed_claim.0013 = {
	type = letter_event
	sender = scope:claim_target
	opening = BMU_TARGET_INVITE_VASSALS
	desc = BMU_TARGET_INVITE_VASSALS_DESC

	trigger = {
		liege = scope:claim_target
		any_owned_story = {
			story_type = BMU_stakeholder
			has_variable = pressed_claim
			var:pressed_claim = scope:story
			count = 0
		}
	}

	immediate = {
		debug_log = "BMU_pressed_claim.0013"
		debug_log_scopes = no

		BMU_create_pressed_claim_stakeholder_story = { PRESSED_CLAIM = scope:story }

		scope:claim_target = { save_scope_as = candidate }
		save_scope_value_as = {
			name = target_score
			value = candidate_score
		}
		set_variable = { name = claim_target value = scope:claim_target }
		set_variable = { name = claim_target_score value = scope:target_score }

		scope:story = {
			ordered_in_list = {
				variable = BMU_pressed_claim_stakeholders
				limit = {
					has_variable = status
					var:status = flag:contender
					NOT = { story_owner = scope:claim_target }
				}
				order_by = {
					if = { limit = { story_owner = { save_temporary_scope_as = candidate }}}
					root = {
						add = candidate_score
					}
				}
				story_owner = {
					save_scope_as = top_candidate
					save_scope_as = candidate
				}
				root = {
					save_scope_value_as = {
						name = top_candidate_score
						value = candidate_score
					}
				}
			}
		}
		set_variable = { name = top_candidate value = scope:top_candidate }
		set_variable = { name = top_candidate_score value = scope:top_candidate_score }

		if = {
			limit = { is_ai = yes }
			if = {
				limit = { scope:target_score > 0 }
				if = {
					limit = {
						ai_greed < {
							add = scope:target_score
							add = FF_loyalty
							subtract = {
								add = scope:top_candidate_score
								min = 0
							}
						}
					}
					set_variable = {
						name = status
						value = flag:supporter_liege
					}
				}
				else = {
					set_variable = {
						name = status
						value = flag:stakeholder
					}
				}
			}
			else_if = {
				limit = { scope:top_candidate_score > 0 }
				if = {
					limit = { ai_greed < scope:top_candidate_score }
					set_variable = {
						name = status
						value = flag:supporter_top_candidate
					}
				}
				else = {
					set_variable = {
						name = status
						value = flag:stakeholder
					}
				}
			}
			else = {
				set_variable = {
					name = status
					value = flag:dropout
				}
			}
		}
	}

	option = {
		name = "BMU_TARGET_INVITE_VASSALS_SUPPORT_LIEGE"
		trigger = { is_ai = no }
		BMU_pressed_claim_supporter = {
			TARGET = scope:claim_target
			TITLE = scope:story.var:claimed_title
			CONTENDER = scope:claim_target
		}
	}

	option = {
		name = "BMU_TARGET_INVITE_VASSALS_STAKEHOLDER"
		trigger = { is_ai = no }
		BMU_pressed_claim_stakeholder = {
			TARGET = scope:claim_target
			TITLE = scope:story.var:claimed_title
		}
	}

	option = {
		name = "BMU_TARGET_INVITE_VASSALS_DROPOUT"
		trigger = { is_ai = no }
		BMU_pressed_claim_dropout = {
			TARGET = scope:claim_target
			TITLE = scope:story.var:claimed_title
		}
	}

	option = {
		name = "BMU_TARGET_INVITE_VASSAL_AI"
		trigger = { is_ai = yes }
		switch = {
			trigger = var:status
			flag:supporter_liege = {
				BMU_pressed_claim_supporter = {
					TARGET = scope:claim_target
					TITLE = scope:story.var:claimed_title
					CONTENDER = scope:claim_target
				}
			}
			flag:supporter_top_candidate = {
				BMU_pressed_claim_supporter = {
					TARGET = scope:claim_target
					TITLE = scope:story.var:claimed_title
					CONTENDER = scope:top_candidate
				}
			}
			flag:stakeholder = {
				BMU_pressed_claim_stakeholder = {
					TARGET = scope:claim_target
					TITLE = scope:story.var:claimed_title
				}
			}
			flag:dropout = {
				BMU_pressed_claim_dropout = {
					TARGET = scope:claim_target
					TITLE = scope:story.var:claimed_title
				}
			}
		}
	}
}

BMU_pressed_claim.0014 = {
	type = letter_event
	sender = scope:chancellor
	opening = BMU_TARGET_INVITE_VASSALS
	desc = BMU_TARGET_INVITE_VASSALS_DESC

	trigger = {
		scope:claim_target = {
			any_realm_county = {
				any_de_jure_top_liege = {
					this = root
				}
			}
		}
		any_owned_story = {
			story_type = BMU_stakeholder
			has_variable = pressed_claim
			var:pressed_claim = scope:story
			count = 0
		}
		any_councillor = { has_council_position = councillor_chancellor }
	}

	immediate = {
		debug_log = "BMU_pressed_claim.0014"
		debug_log_scopes = no

		random_councillor = {
			limit = { has_council_position = councillor_chancellor }
			save_scope_as = chancellor
		}
		create_story = {
			type = BMU_stakeholder
			save_scope_as = BMU_stakeholder
		}
		scope:BMU_stakeholder = {
			set_variable = {
				name = pressed_claim
				value = scope:story
			}
		}
		scope:story = {
			add_to_variable_list = {
				name = BMU_pressed_claim_stakeholders
				target = scope:BMU_stakeholder
			}
		}
	}

	option = {
		name = "BMU_TARGET_INVITE_VASSALS_STAKEHOLDER"
		ai_chance = {
			base = 100
		}
		scope:BMU_stakeholder = {
			set_variable = {
				name = status
				value = flag:stakeholder
			}
		}
	}

	option = {
		name = "BMU_TARGET_INVITE_VASSALS_DROPOUT"
		ai_chance = {
			base = 0
		}
		scope:BMU_stakeholder = {
			set_variable = {
				name = status
				value = flag:dropout
			}
		}
	}
}